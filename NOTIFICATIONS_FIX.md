# Исправление дублирования уведомлений

## Проблема
Бот многократно отправлял уведомления «Запись отменена/создана/изменена» при каждой синхронизации.

## Принятые меры

### 1. Уникальный индекс в БД
- ` notifications(appointment_id, type)` — одно уведомление каждого типа на запись
- При попытке создать дубликат: `IntegrityError` → откат, без повторной отправки

### 2. Фильтр в планировщике
- Обрабатываются только записи, для которых ещё **нет** уведомления соответствующего типа
- SQL: `NOT EXISTS (SELECT 1 FROM notifications WHERE ... AND type = appointment.status)`

### 3. Проверка `once_only` в create_notification
- Перед созданием проверяется наличие уведомления с таким `(appointment_id, type)`

### 4. Нормализация ключей при синхронизации
- Единый формат даты (DD.MM.YYYY) и trim пробелов
- Исключаются дубликаты при `09.02` vs `9.02`

### 5. Защита внутри одной синхронизации
- Созданные записи сразу добавляются в `existing_appointments`, чтобы не плодить дубликаты

### 6. Исправлен текст «changed»
- Было: «Запись отменена» (как у canceled)
- Стало: «Ваша запись изменена» с новыми данными

## Как применить
1. Остановить бота
2. Запустить `python init_db.py` (применит миграцию индекса)
3. Запустить бота
